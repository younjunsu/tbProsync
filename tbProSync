#!/bin/bash

# SOURCE DB/USR
DB_USER=sys
DB_PASS=tibero

# SOURCE/TARGET 구성
PROSYNC_SOURCE_MODE=TAC
PROSYNC_TARGET_MODE=TAC
PROSYNC_SOURCE_TOP_ID=prosync_sync
PROSYNC_TARGET_TOP_ID=${PROSYNC_SOURCE_TOP_ID}

# SOURCE/TARGET 유저
PROSYNC_SOURCE_USER=prosync
PROSYNC_TARGET_USER=prosync

# SOURCE/TARGET 유저
PROSYNC_SOURCE_USER=prosync
PROSYNC_TARGET_USER=prosync

# SOURCE/TARGET 디비 링크
PROSYNC_SOURCE_DBLINK=p_source
PROSYNC_TARGET_DBLINK=p_target


#####################################################################################
# 테스트트
# SOURCE/TARGET 동기화 차이 확인
# PROSYNC_SOURCE_TSN=$((RANDOM % 32767)) #랜덤 16비트 정수의 최대 값 32767
# PROSYNC_TARGET_TSN=$((RANDOM % 32767)) #랜덤 16비트 정수의 최대 값 32767
# PROSYNC_TSN_GAP=$((PROSYNC_SOURCE_TSN - PROSYNC_TARGET_TSN)) #랜덤 16비트 정수의 최대 값 32767

# PROSYNC_CURRENT_TIME=`date +%Y/%m/%d" "%T`

# PROSYNC_SOURCE_TIME=`date +%Y/%m/%d" "%T`
# PROSYNC_TARGET_TIME=`date +%Y/%m/%d" "%T`

# PROSYNC_TARGET_TSN=$((RANDOM % 32767)) #랜덤 16비트 정수의 최대 값 32767

# PROSYNC_SOURCE_UNIX_TIME=`date +%s`
# PROSYNC_TARGET_UNIX_TIME=`date +%s`
# PROSYNC_TARGET_UNIX_TIME=$((PROSYNC_TARGET_UNIX_TIME - 1))
# PROSYNC_UNIX_TIME_GAP=$((PROSYNC_SOURCE_UNIX_TIME - PROSYNC_TARGET_UNIX_TIME))

# ROSYNC_HOURS_TIME_GAP=$((PROSYNC_UNIX_TIME_GAP / 3600))  # 시간
# PROSYNC_MINUTES_TIME_GAP=$(((PROSYNC_UNIX_TIME_GAP % 3600) / 60))  # 분
# PROSYNC_SECONDS_TIME_GAP=$((PROSYNC_UNIX_TIME_GAP % 60))  # 초



function_source_target_gap(){
# 소스 
SOURCE_DATE_TSN=`tbsql ${DB_USER}/${DB_PASS} -s <<EOF
set pagesize 0
set feedback off
SELECT
'success'||','||
to_char(sysdate,'YYYY/MM/DD HH24:MI:SS')||','||
TRUNC((CAST(sysdate as date) - TO_DATE('1970-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')) * 86400)||','||
current_tsn as source_date_tsn
FROM 
v\\$database;
EOF`


# 타겟 
TARGET_DATE_TSN=`tbsql ${DB_USER}/${DB_PASS} -s <<EOF
set pagesize 0
set feedback off
select
'success'||','||
to_char(time,'YYYY/MM/DD HH24:MI:SS')||','||
TRUNC((CAST(time as date) - TO_DATE('1970-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')) * 86400)||','||
tsn as target_date_tsn
from prs_lct;
EOF`

PROSYNC_CURRENT_TIME=`echo ${SOURCE_DATE_TSN} |awk -F , '{print $2}'`
PROSYNC_SOURCE_TIME=`echo ${SOURCE_DATE_TSN} |awk -F , '{print $2}'`
PROSYNC_SOURCE_UNIX_TIME=`echo ${SOURCE_DATE_TSN} |awk -F , '{print $3}'`
PROSYNC_SOURCE_TSN=`echo ${SOURCE_DATE_TSN} |awk -F , '{print $4}'`
PROSYNC_TARGET_TIME=`echo ${TARGET_DATE_TSN} |awk -F , '{print $2}'`
PROSYNC_TARGET_UNIX_TIME=`echo ${TARGET_DATE_TSN} |awk -F , '{print $3}'`
PROSYNC_TARGET_TSN=`echo ${TARGET_DATE_TSN} |awk -F , '{print $4}'`
PROSYNC_UNIX_TIME_GAP=$((PROSYNC_SOURCE_UNIX_TIME - PROSYNC_TARGET_UNIX_TIME))
PROSYNC_HOURS_TIME_GAP=$((PROSYNC_UNIX_TIME_GAP / 3600))  # 시간
PROSYNC_MINUTES_TIME_GAP=$(((PROSYNC_UNIX_TIME_GAP % 3600) / 60))  # 분
PROSYNC_SECONDS_TIME_GAP=$((PROSYNC_UNIX_TIME_GAP % 60))  # 초
PROSYNC_TSN_GAP=$((PROSYNC_SOURCE_TSN - PROSYNC_TARGET_TSN))
echo "$PROSYNC_CURRENT_TIME"
echo "$PROSYNC_SOURCE_TIME"
echo "$PROSYNC_SOURCE_UNIX_TIME"
echo "$PROSYNC_SOURCE_TSN"
echo "$PROSYNC_TARGET_TIME"
echo "$PROSYNC_TARGET_UNIX_TIME"
echo "$PROSYNC_TARGET_TSN"
echo "$PROSYNC_UNIX_TIME_GAP"
echo "$PROSYNC_HOURS_TIME_GAP"
echo "$PROSYNC_MINUTES_TIME_GAP"
echo "$PROSYNC_SECONDS_TIME_GAP"
echo "$PROSYNC_TSN_GAP"
}


function_source_target_gap

clear
echo ""
printf "############################################################################################################\n"
printf " ProSync GAP TSN Checking\n"
printf "############################################################################################################\n"
printf "  %-30s %-30s %-30s\n" "SOURCE(${PROSYNC_SOURCE_MODE})" "TARGET(${PROSYNC_TARGET_MODE})" "TSN GAP/CURRENT TIME"
printf " %-30s %-30s %-30s\n" "------------------" "------------------" "------------------------------------------"
printf "  %-30s %-30s %-30s\n" "${PROSYNC_SOURCE_USER}" "${PROSYNC_TARGET_USER}" "GAP: ${PROSYNC_TSN_GAP} (CUR: ${PROSYNC_CURRENT_TIME})"
#printf "  %-30s %-30s %-30s\n" "" "" "${PROSYNC_CURRENT_TIME}"
printf "\n"
printf "############################################################################################################\n"
printf " ProSync SOURCE/TARGET TSN Checking\n"
printf "############################################################################################################\n"
printf "   - CURRENT TIME      : %-10s\n" "$PROSYNC_CURRENT_TIME"
printf "   - SOURCE TSN(TIME)  : %-10d         (apply time: %-20s)\n" "$PROSYNC_SOURCE_TSN" "$PROSYNC_SOURCE_TIME"
printf "   - TARGET TSN(TIME)  : %-10d         (apply time: %-20s)\n" "$PROSYNC_TARGET_TSN" "$PROSYNC_TARGET_TIME"
printf "   - SOURCE/TARGET GAP : %-10d         (gap time: %-2d hours, %-2d minutes, %-2d seconds)\n" \
       "$PROSYNC_TSN_GAP" "$PROSYNC_HOURS_TIME_GAP" "$PROSYNC_MINUTES_TIME_GAP" "$PROSYNC_SECONDS_TIME_GAP"
printf "\n"
printf "############################################################################################################\n"
printf " ProSync Meta Checking\n"
printf "############################################################################################################\n"
echo "  * SOURCE META"
echo "   - PROSYNC_SOURCE_MODE: ${PROSYNC_SOURCE_MODE}"
echo "   - PROSYNC_SOURCE_TOP_ID: ${PROSYNC_SOURCE_TOP_ID}"
echo "   - PROSYNC_SOURCE_DBLINK: ${PROSYNC_SOURCE_DBLINK}"
echo
echo "  * TARGET META"
echo "   - PROSYNC_TARGET_MODE: ${PROSYNC_TARGET_MODE}"
echo "   - PROSYNC_TARGET_TOP_ID: ${PROSYNC_TARGET_TOP_ID}"
echo "   - PROSYNC_TARGET_DBLINK: ${PROSYNC_TARGET_DBLINK}"
echo ""
echo ""